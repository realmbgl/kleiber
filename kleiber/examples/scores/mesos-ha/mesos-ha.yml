name: mesos

parameters:
   datacenter: tor01
   domain: mesos.mbgl2.domain
   key: siv

datacenter: "{{ parameters.datacenter }}"

mappings:
   servertypes:
      medium:
         cpus: 4
         memory: 8192
         hourly: True

resources:
   serverinstances:
      masters:
        servertype: medium
        count: 1
        os_code: UBUNTU_LATEST_64
        domain: "{{ parameters.domain }}"
        keyname: "{{ parameters.key }}"
        hostname: "{{ clustername }}-master"
        script: master.sh
        userdata: '
          CLUSTERSIZE="{{ resources["serverinstances"]["masters"]["count"] }}"
          CONTAINER="{{ clustername }}"
          SWIFTIDENTITY="{{ parameters.swiftuser }}"
          SWIFTAPIKEY="{{ parameters.swiftkey }}"
          SWIFTAUTHURL="https://{{ parameters.datacenter}}.objectstorage.softlayer.net/auth/v1.0"
        '

      frontendlb:
        dependson: masters
        servertype: medium
        count: 1
        os_code: UBUNTU_LATEST_64
        domain: "{{ parameters.domain }}"
        keyname: "{{ parameters.key }}"
        hostname: "{{ clustername }}-frontendlb"
        script: nginx-ar.sh
        userdata: '
          HTTPPORTS="8090 8080 5050 8123"
          DCOS_PROXY="yes"
          HTTPSERVERS="{% for master in resources["serverinstances"]["masters"]["vms"] %}
            {{ master["primaryIpAddress"] }}
            {%endfor%}"
        '

      backendlb:
        dependson: masters
        servertype: medium
        count: 1
        os_code: UBUNTU_LATEST_64
        domain: "{{ parameters.domain }}"
        keyname: "{{ parameters.key }}"
        hostname: "{{ clustername }}-backendlb"
        script: nginx.sh
        userdata: '
          HTTPPORTS="5050 8123 8090"
          HTTPSERVERS="{% for master in resources["serverinstances"]["masters"]["vms"] %}
            {{ master["primaryIpAddress"] }}
            {%endfor%}"
          TCPPORTS="2181 53"
          TCPSERVERS="{% for master in resources["serverinstances"]["masters"]["vms"] %}
            {{ master["primaryIpAddress"] }}
            {%endfor%}"
        '

      privateslaves:
        dependson: backendlb
        servertype: medium
        count: 1
        os_code: UBUNTU_LATEST_64
        domain: "{{ parameters.domain }}"
        keyname: "{{ parameters.key }}"
        hostname: "{{ clustername }}-privateslave"
        script: privateslave.sh
        userdata: '{% for master in resources["serverinstances"]["backendlb"]["vms"] %}
            {{ master["primaryIpAddress"] }}
            {%endfor%}
        '

      publicslaves:
        dependson: backendlb
        servertype: medium
        count: 1
        os_code: UBUNTU_LATEST_64
        domain: "{{ parameters.domain }}"
        keyname: "{{ parameters.key }}"
        hostname: "{{ clustername }}-publicslave"
        script: publicslave.sh
        userdata: '{% for master in resources["serverinstances"]["backendlb"]["vms"] %}
            {{ master["primaryIpAddress"] }}
            {%endfor%}
        '

post-scripts:
  "waitForUp-ar.py":
    - '{{ resources["serverinstances"]["frontendlb"]["vms"][0]["primaryIpAddress"] }}'
    - '{{ resources["serverinstances"]["privateslaves"]["count"] }}'
    - '{{ resources["serverinstances"]["publicslaves"]["count"] }}'

cleanup-scripts:
  "cleanup.py":
    - '{{ parameters.swiftuser }}'
    - '{{ parameters.swiftkey }}'
    - '{{ parameters.datacenter }}'
    - '{{ clustername }}'

output:
  template: |
    dcos_url: "http://{{ resources["serverinstances"]["frontendlb"]["vms"][0]["primaryIpAddress"] }}"
    mesos: "http://{{ resources["serverinstances"]["frontendlb"]["vms"][0]["primaryIpAddress"] }}/mesos"
    marathon: "http://{{ resources["serverinstances"]["frontendlb"]["vms"][0]["primaryIpAddress"] }}/marathon"
    exhibitor: "http://{{ resources["serverinstances"]["frontendlb"]["vms"][0]["primaryIpAddress"] }}/exhibitor"
